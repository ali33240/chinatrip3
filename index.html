<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>é›²å—è‡ªåŠ©ä¹‹æ—… 2026</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- FontAwesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Noto+Serif+TC:wght@500;700;900&display=swap" rel="stylesheet">
    <!-- SortableJS -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.0/Sortable.min.js"></script>
    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'earth-dark': '#2d1b0e', 
                        'earth-primary': '#6d4c41', 
                        'earth-accent': '#8d6e63', 
                        'earth-light': '#d7ccc8', 
                        'clay-red': '#b71c1c',    
                        'warm-bg': '#fffbf0',     
                        'gold-accent': '#f9a825', 
                    },
                    fontFamily: {
                        serif: ['"Noto Serif TC"', 'serif'],
                        sans: ['-apple-system', 'BlinkMacSystemFont', '"Segoe UI"', 'Roboto', 'sans-serif'],
                    }
                }
            }
        }
    </script>
    <style>
        body { 
            font-family: 'Noto Serif TC', serif; 
            background-color: #fffbf0; 
            color: #1a1a1a; 
            padding-bottom: 120px; 
            background-image: url("data:image/svg+xml,%3Csvg width='60' height='60' viewBox='0 0 60 60' xmlns='http://www.w3.org/2000/svg'%3E%3Cg fill='none' fill-rule='evenodd'%3E%3Cg fill='%23b08968' fill-opacity='0.05'%3E%3Cpath d='M36 34v-4h-2v4h-4v2h4v4h2v-4h4v-2h-4zm0-30V0h-2v4h-4v2h4v4h2V6h4V4h-4zM6 34v-4H4v4H0v2h4v4h2v-4h4v-2H6zM6 4V0H4v4H0v2h4v4h2V6h4V4H6z'/%3E%3C/g%3E%3C/g%3E%3C/svg%3E");
            font-size: 18px; 
            line-height: 1.6;
            -webkit-tap-highlight-color: transparent;
        }
        
        h1, h2, h3, h4 { font-weight: 700 !important; }
        
        .tab-content { display: none; animation: fadeIn 0.3s ease-out; }
        .tab-content.active { display: block; }
        
        .nav-item.active { color: #5d4037; position: relative; font-weight: bold; transform: scale(1.1); transition: transform 0.2s; }
        .nav-item.active::after {
            content: ''; position: absolute; bottom: -8px; left: 50%; transform: translateX(-50%);
            width: 8px; height: 8px; background-color: #c62828; border-radius: 50%;
        }

        .card-earth { 
            background: #ffffff; 
            border: 1px solid #d7ccc8; 
            border-radius: 16px; 
            box-shadow: 4px 4px 0px rgba(121, 85, 72, 0.1); 
            margin-bottom: 24px; position: relative;
        }
        
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }

        .day-tab.active {
            background-color: #5d4037; color: #ffffff; border-color: #5d4037;
            box-shadow: 0 6px 8px -1px rgba(62, 39, 35, 0.4);
            transform: scale(1.1);
        }

        .timeline-line { position: absolute; left: 24px; top: 0; bottom: 0; width: 2px; background-color: #d7ccc8; z-index: 0; }
        .timeline-dot {
            position: absolute; left: -9px; top: 6px; width: 14px; height: 14px; 
            border-radius: 50%; background-color: #c62828; border: 2px solid #ffffff;
            box-shadow: 0 0 0 1px #c62828;
        }
        
        .weather-loading { animation: pulse 1.5s infinite; }
        @keyframes pulse { 0% { opacity: 0.6; } 50% { opacity: 1; } 100% { opacity: 0.6; } }

        .modal-enter { animation: modalFadeIn 0.2s ease-out forwards; }
        @keyframes modalFadeIn { from { opacity: 0; transform: scale(0.95); } to { opacity: 1; transform: scale(1); } }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
        
        .handle { cursor: grab; touch-action: none; }
        .sortable-ghost { opacity: 0.4; background-color: #f5f5f5; border: 2px dashed #999; }
    </style>
</head>
<body class="antialiased">

    <!-- Header -->
    <header class="bg-earth-dark text-earth-light p-5 sticky top-0 z-50 shadow-md border-b-4 border-earth-primary">
        <div class="flex justify-between items-center max-w-lg mx-auto">
            <div>
                <h1 class="text-3xl font-bold text-[#ffffff] mb-1">é›²å—è‡ªéŠ</h1>
                <div class="flex items-center text-sm text-earth-light mt-1 space-x-2 opacity-90">
                    <span class="border border-earth-light px-2 py-0.5 rounded">2026 è²³æœˆ</span>
                    <span class="tracking-wider">æ·±åº¦æ–‡åŒ–è¡Œ</span>
                </div>
            </div>
            <div class="text-center bg-white/10 p-2 rounded border border-white/20 backdrop-blur-sm">
                 <div class="text-[10px] uppercase tracking-widest opacity-80 font-sans text-white">ç¸½å¤©æ•¸</div>
                <div class="text-2xl font-bold leading-none text-[#ffffff] mt-0.5" id="total-days-display">12</div>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="max-w-lg mx-auto relative px-3 pt-4">

        <!-- 1. è¡Œç¨‹ Tab -->
        <div id="tab-itinerary" class="tab-content active">
            <div class="sticky top-[100px] z-40 bg-[#fffbf0]/98 backdrop-blur-sm border-b border-earth-light shadow-sm py-4 px-2 overflow-x-auto whitespace-nowrap no-scrollbar" id="day-tabs-container"></div>
            <div class="py-4 min-h-[60vh]" id="day-content-container"></div>
            <div class="flex justify-between px-2 text-earth-primary text-base font-bold opacity-90 pb-8">
                <button onclick="changeDay(-1)" id="prev-day-btn" class="disabled:opacity-20 py-3 px-6 bg-white border border-earth-light rounded-lg shadow-sm"><i class="fas fa-chevron-left mr-2"></i> å‰ä¸€å¤©</button>
                <button onclick="changeDay(1)" id="next-day-btn" class="disabled:opacity-20 py-3 px-6 bg-white border border-earth-light rounded-lg shadow-sm">å¾Œä¸€å¤© <i class="fas fa-chevron-right ml-2"></i></button>
            </div>
        </div>

        <!-- 2. è¨˜å¸³ Tab -->
        <div id="tab-budget" class="tab-content p-2">
            <!-- åŒ¯ç‡æ›ç®—å™¨ (å·¦å³äº’æ›) -->
            <div class="card-earth p-4 bg-earth-dark/5 border-dashed border border-earth-accent mb-4">
                <h3 class="text-base font-bold text-earth-dark text-center mb-2"><i class="fas fa-calculator mr-2"></i>åŒ¯ç‡æ›ç®—</h3>
                <div class="flex items-center gap-2">
                    <div class="flex-1">
                        <label class="block text-xs text-center text-gray-500 mb-1">äººæ°‘å¹£ (CNY)</label>
                        <input type="number" id="calc-cny" class="w-full p-2 text-center rounded border border-earth-light focus:border-earth-primary text-lg font-bold" placeholder="Â¥" oninput="calculateRate('cny')">
                    </div>
                    <i class="fas fa-exchange-alt text-earth-accent text-xl mt-4"></i>
                    <div class="flex-1">
                        <label class="block text-xs text-center text-gray-500 mb-1">æ–°å°å¹£ (TWD)</label>
                        <input type="number" id="calc-twd" class="w-full p-2 text-center rounded border border-earth-light focus:border-earth-primary text-lg font-bold" placeholder="$" oninput="calculateRate('twd')">
                    </div>
                </div>
                <div class="flex justify-center items-center mt-2 text-xs text-gray-500 gap-2">
                    <span>åŒ¯ç‡: 1 äººæ°‘å¹£ = </span><input type="number" id="current-rate" value="4.5" class="w-12 p-1 text-center border rounded bg-white" onchange="updateRate()"><span>å°å¹£</span>
                </div>
            </div>

            <!-- æˆå“¡è¨­å®šæŒ‰éˆ• -->
            <div class="flex justify-end mb-2">
                <button onclick="document.getElementById('member-modal').classList.remove('hidden')" class="text-sm text-earth-primary underline font-bold"><i class="fas fa-users-cog mr-1"></i>æˆå“¡ç®¡ç†</button>
            </div>

            <!-- çµç®—çœ‹æ¿ -->
            <div class="card-earth p-5 bg-earth-dark text-earth-light border-none shadow-lg mb-6">
                <h3 class="text-base opacity-80 font-sans mb-3 text-center">ç•¶å‰åˆ†å¸³çµç®— (æŠ˜åˆäººæ°‘å¹£)</h3>
                <div id="balance-board" class="space-y-2 text-center text-lg"><p class="text-sm italic opacity-60">æš«ç„¡å¸³ç›®è³‡æ–™</p></div>
                <div class="mt-4 pt-3 border-t border-white/20 text-center text-xs opacity-60">
                    *åˆ†å¸³è¨ˆç®—çµ±ä¸€æŠ˜ç®—ç‚ºäººæ°‘å¹£ï¼Œæ–¹ä¾¿çµç®—
                </div>
            </div>

            <!-- è¨˜å¸³è¡¨å–® -->
            <div class="card-earth p-6 sticky top-[110px] z-40 shadow-lg bg-white border-l-4 border-earth-primary">
                
                <!-- ç¸½æ”¯å‡ºé¡¯ç¤º -->
                <div class="mb-6 border-b border-dashed border-earth-light pb-4">
                    <div class="flex justify-between items-end mb-2">
                        <p class="text-sm text-gray-500 font-sans tracking-wider font-bold">ç¸½æ”¯å‡ºçµ±è¨ˆ</p>
                        <button onclick="clearAllData('expenses')" class="text-xs text-gray-400 underline">é‡ç½®</button>
                    </div>
                    <div class="flex flex-col items-end space-y-1">
                        <div class="text-xl font-bold text-earth-dark">äººæ°‘å¹£ç¸½æ”¯: Â¥ <span id="sum-cny" class="text-2xl">0</span></div>
                        <div class="text-xl font-bold text-blue-800">å°å¹£ç¸½æ”¯: NT$ <span id="sum-twd" class="text-2xl">0</span></div>
                        <div class="text-sm text-gray-400 mt-1">æŠ˜åˆç¸½è¨ˆç´„: NT$ <span id="total-est-twd">0</span></div>
                    </div>
                </div>

                <h3 class="font-bold text-xl text-earth-dark mb-4">æ–°å¢æ”¯å‡º</h3>
                <form id="expense-form" class="space-y-4 font-sans">
                    <input type="text" id="item-name" placeholder="é …ç›®åç¨± (å¦‚: æ™šé¤)" class="w-full p-3 bg-gray-50 border border-earth-light rounded focus:border-earth-primary outline-none text-lg" required>
                    <div class="flex gap-3">
                        <select id="item-currency" class="w-1/3 p-3 bg-gray-50 border border-earth-light rounded outline-none font-bold text-earth-dark text-lg"><option value="CNY">Â¥ CNY</option><option value="TWD">$ TWD</option></select>
                        <input type="number" id="item-price" placeholder="é‡‘é¡" class="w-2/3 p-3 bg-gray-50 border border-earth-light rounded focus:border-earth-primary outline-none text-lg" required>
                    </div>
                    <div class="bg-warm-bg p-3 rounded border border-earth-light/50">
                        <div class="flex items-center justify-between mb-3"><label class="text-sm font-bold text-earth-primary">èª°å…ˆä»˜éŒ¢ï¼Ÿ</label><select id="item-payer" class="text-base p-1 border rounded bg-white w-32 font-bold text-center"></select></div>
                        <div class="mb-1"><label class="text-sm font-bold text-earth-primary block mb-2">åˆ†æ”¤äºº (é è¨­å…¨é¸)ï¼š</label><div id="item-involved" class="grid grid-cols-2 gap-2"></div></div>
                    </div>
                    <!-- æŒ‰éˆ•é¡å‹è¨­ç‚º submitï¼Œä¸¦ç¶å®šID -->
                    <button type="submit" id="add-expense-btn" class="w-full py-4 bg-earth-primary text-white rounded shadow hover:bg-earth-dark transition-colors font-bold tracking-widest mt-2 text-lg">è¨˜ä¸Šä¸€ç­†</button>
                </form>
            </div>
            <div id="expense-list" class="space-y-4 pb-20"></div>
        </div>

        <!-- 3. å°è¦½ Tab -->
        <div id="tab-guide" class="tab-content p-2">
            <div class="flex gap-3 mb-6 overflow-x-auto no-scrollbar pb-2">
                <button onclick="scrollToId('guide-safety')" class="px-4 py-2 bg-red-100 text-red-800 rounded-full text-base font-bold whitespace-nowrap">âš ï¸ å®‰å…¨</button>
                <button onclick="scrollToId('guide-food')" class="px-4 py-2 bg-yellow-100 text-yellow-800 rounded-full text-base font-bold whitespace-nowrap">ğŸ´ ç¾é£Ÿ</button>
                <button onclick="scrollToId('guide-gift')" class="px-4 py-2 bg-purple-100 text-purple-800 rounded-full text-base font-bold whitespace-nowrap">ğŸ ä¼´æ‰‹ç¦®</button>
                <button onclick="scrollToId('guide-spot')" class="px-4 py-2 bg-blue-100 text-blue-800 rounded-full text-base font-bold whitespace-nowrap">ğŸ”ï¸ æ™¯é»</button>
            </div>
            <div id="guide-safety" class="bg-red-50 border-l-4 border-red-500 p-5 mb-8 rounded-lg shadow-sm">
                <h3 class="font-bold text-xl mb-3 text-clay-red flex items-center"><i class="fas fa-heartbeat mr-2"></i>é«˜åŸå®‰å…¨</h3>
                <ul class="list-disc pl-6 text-base text-red-900 space-y-2 font-bold"><li>éº—æ±Ÿç¬¬ä¸€å¤©<strong>çµ•å°ä¸æ´—é ­</strong> (é˜²é¢¨å¯’)ã€‚</li><li><strong>å‹•ä½œæ”¾æ…¢</strong>ï¼Œä¸å¯åŠ‡çƒˆé‹å‹•ã€‚</li><li>å‚™å¥½æ°§æ°£ç“¶ï¼Œé ­ç—›æ™‚å¸æ°§ã€‚</li></ul>
            </div>
            <div id="guide-food" class="mb-10"><h3 class="font-bold text-2xl mb-5 text-earth-dark border-b border-earth-light pb-2 text-center">ç¾é£Ÿåœ°åœ–</h3><div id="food-guide-list" class="space-y-8"></div></div>
            <div id="guide-gift" class="mb-10"><h3 class="font-bold text-2xl mb-5 text-earth-dark border-b border-earth-light pb-2 text-center">ä¼´æ‰‹ç¦®</h3><div id="souvenir-guide-list" class="space-y-6"></div></div>
            <div id="guide-spot" class="mb-10"><h3 class="font-bold text-2xl mb-5 text-earth-dark border-b border-earth-light pb-2 text-center">æ™¯é»æ·±åº¦å°è¦½</h3><div id="spot-guide-list" class="space-y-8"></div></div>
        </div>

        <!-- 4. è³‡è¨Š Tab -->
        <div id="tab-info" class="tab-content p-2">
            <div class="card-earth p-5 border-l-8 border-l-earth-primary mb-6">
                <div class="flex justify-between items-center mb-4 border-b border-earth-light pb-2"><h3 class="font-bold text-xl text-earth-dark"><i class="fas fa-plane mr-2"></i>èˆªç­è³‡è¨Š</h3><button onclick="clearAllData('flights')" class="text-sm text-gray-400">æ¸…é™¤</button></div>
                <form id="flight-form" class="space-y-4 mb-4"><input type="text" id="flight-info-str" placeholder="ä¾‹: 2/1 19:50 æ˜†æ˜ CI553" class="w-full p-3 border border-earth-light rounded font-medium text-lg" required><button type="submit" class="w-full bg-earth-accent text-white py-3 rounded text-base font-bold">æ–°å¢èˆªç­</button></form>
                <div id="flight-list" class="space-y-3 text-base"></div>
            </div>

            <div class="card-earth p-5 bg-white mb-6">
                <h3 class="font-bold text-xl text-earth-dark mb-5 border-b pb-3"><i class="fas fa-lightbulb mr-2 text-gold-accent"></i>å¯¦ç”¨è³‡è¨Š</h3>
                <div class="space-y-5">
                    <div class="bg-warm-bg p-4 rounded border border-earth-light/50"><h4 class="font-bold text-earth-primary mb-2 text-lg"><i class="fas fa-tshirt mr-2"></i>ç©¿è‘—å»ºè­° (æ´‹è”¥å¼)</h4><p class="text-base text-gray-800 font-medium">æ—©æ™šæº«å·®æ¥µå¤§(å¯é”15åº¦)ã€‚<br><strong>å…§å±¤ï¼š</strong>æ’æ±—è¡£/ç™¼ç†±è¡£ã€‚<br><strong>ä¸­å±¤ï¼š</strong>åˆ·æ¯›è¡£/ç¾½çµ¨èƒŒå¿ƒ (ä¿æš–)ã€‚<br><strong>å¤–å±¤ï¼š</strong>é˜²é¢¨é˜²æ°´å¤–å¥— (è¡é‹’è¡£)ã€‚<br><strong>é…ä»¶ï¼š</strong>æ¯›å¸½(å¿…å‚™ï¼Œé˜²é ­ç—›)ã€å¢¨é¡ã€é˜²æ›¬ä¹³ã€‚</p></div>
                    <div class="bg-warm-bg p-4 rounded border border-earth-light/50"><h4 class="font-bold text-earth-primary mb-2 text-lg"><i class="fas fa-wifi mr-2"></i>ç¶²å¡èˆ‡ç¶²è·¯</h4><p class="text-base text-gray-800 font-medium"><strong>æ¼«éŠ/ä¸­æ¸¯æ¾³ç¶²å¡ï¼š</strong>æ¨è–¦ä½¿ç”¨ï¼Œ<strong>å…ç¿»ç‰†</strong>å¯ç›´æ¥ç”¨ Line/FB/IGã€‚<br><strong>æ”¯ä»˜ï¼š</strong>æ”¯ä»˜å¯¶/å¾®ä¿¡æ”¯ä»˜ç¶å®šå°ç£ä¿¡ç”¨å¡ï¼Œå¤§å¤šåº—å®¶éƒ½å¯åˆ·ã€‚</p></div>
                    <div class="bg-warm-bg p-4 rounded border border-earth-light/50"><h4 class="font-bold text-earth-primary mb-2 text-lg"><i class="fas fa-plug mr-2"></i>é›»å£“èˆ‡æ’åº§</h4><p class="text-base text-gray-800 font-medium"><strong>é›»å£“ï¼š</strong>220V (å°ç£æ˜¯110V)ã€‚<br><strong>æ’åº§ï¼š</strong>å…©å­”æ’åº§(æ‰é ­)èˆ‡å°ç£é€šç”¨ã€‚ä¸‰å­”æ˜¯å…«å­—å‹ã€‚</p></div>
                    <div class="bg-warm-bg p-4 rounded border border-earth-light/50"><h4 class="font-bold text-earth-primary mb-2 text-lg"><i class="fas fa-taxi mr-2"></i>äº¤é€šå‡ºè¡Œ</h4><p class="text-base text-gray-800 font-medium"><strong>å«è»Šï¼š</strong>ä¸‹è¼‰ã€Œæ»´æ»´å‡ºè¡Œã€ã€‚<br><strong>åœ°åœ–ï¼š</strong>ç•¶åœ°ç”¨ã€Œé«˜å¾·åœ°åœ–ã€æˆ–ã€Œç™¾åº¦åœ°åœ–ã€æœ€æº–ã€‚<br><strong>é«˜éµï¼š</strong>éœ€æŒå°èƒè­‰èµ°ã€Œäººå·¥é€šé“ã€ã€‚</p></div>
                </div>
            </div>

            <div class="card-earth p-5 border-l-8 border-l-clay-red mb-6">
                <h3 class="font-bold text-xl mb-4 text-clay-red"><i class="fas fa-phone-alt mr-2"></i>ç·Šæ€¥è¯çµ¡</h3>
                <div class="bg-red-50 p-4 rounded text-base mb-4"><span class="font-bold text-red-900 block mb-1">æµ·åŸºæœƒç·Šæ€¥å°ˆç·šï¼š</span><a href="tel:+886225339995" class="text-red-600 font-mono text-xl font-bold">+886-2-2533-9995</a></div>
                <div class="flex justify-around text-center"><a href="tel:110" class="block bg-white p-3 rounded w-24 border border-earth-light font-black text-3xl text-earth-dark">110</a><a href="tel:120" class="block bg-white p-3 rounded w-24 border border-earth-light font-black text-3xl text-earth-dark">120</a></div>
            </div>

            <div class="card-earth p-5 bg-yellow-50/40 border-yellow-200/50">
                <h3 class="font-bold text-lg text-earth-dark mb-4"><i class="fas fa-share-nodes mr-2"></i>å‚™ä»½èˆ‡åˆ†äº«</h3>
                <div class="flex gap-4">
                    <button onclick="exportData()" class="flex-1 bg-earth-primary text-white py-3 rounded shadow hover:bg-earth-dark text-base font-bold text-center">åŒ¯å‡ºæª”æ¡ˆ</button>
                    <label class="flex-1 bg-white text-earth-primary border border-earth-primary py-3 rounded shadow-sm text-base font-bold text-center cursor-pointer">åŒ¯å…¥æª”æ¡ˆ<input type="file" id="import-file" class="hidden" accept=".json" onchange="importData(this)"></label>
                </div>
            </div>
        </div>

        <!-- 5. æª¢æŸ¥è¡¨ Tab -->
        <div id="tab-check" class="tab-content p-2">
            <div class="bg-earth-primary text-white p-5 rounded-lg shadow-md mb-6 flex justify-between items-center">
                <div><h2 class="text-xl font-bold tracking-wider">è¡Œå›Šæ¸…å–®</h2></div>
                <div class="text-right"><div class="text-3xl font-bold font-serif text-yellow-300" id="check-progress">0%</div></div>
            </div>
            <div class="card-earth p-5 mb-6 bg-white">
                <form id="checklist-form" class="flex gap-2 mb-4"><input type="text" id="new-check-item" placeholder="æ–°å¢ç‰©å“..." class="flex-1 p-3 border border-earth-light rounded outline-none" required><button type="submit" class="bg-earth-primary text-white px-6 rounded font-bold"><i class="fas fa-plus"></i></button></form>
                <div id="checklist-container" class="space-y-4"></div>
                <div class="text-center mt-4"><button onclick="resetChecklist()" class="text-sm text-gray-400 underline">é‡ç½®</button></div>
            </div>
            <div class="card-earth p-5 bg-yellow-50/20 border-yellow-200">
                <h2 class="text-xl font-bold mb-4 text-earth-dark"><i class="fas fa-sticky-note mr-2 text-gold-accent"></i>å‚™å¿˜éŒ„</h2>
                <form id="memo-form" class="flex gap-2 mb-4"><input type="text" id="new-memo-item" placeholder="æ–°å¢å‚™å¿˜..." class="flex-1 p-3 border border-earth-light rounded outline-none" required><button type="submit" class="bg-gold-accent text-white px-6 rounded font-bold"><i class="fas fa-plus"></i></button></form>
                <div id="memo-container" class="space-y-3"></div>
            </div>
        </div>

    </main>

    <!-- Bottom Navigation -->
    <nav class="fixed bottom-0 left-0 w-full bg-[#fffbf0] border-t border-earth-primary flex justify-around py-4 z-50 text-gray-600 text-sm font-bold shadow-[0_-4px_10px_rgba(0,0,0,0.1)]">
        <button class="nav-item active flex flex-col items-center w-1/5" onclick="switchTab('itinerary', this)"><i class="fas fa-scroll text-2xl mb-1"></i><span>è¡Œç¨‹</span></button>
        <button class="nav-item flex flex-col items-center w-1/5" onclick="switchTab('budget', this)"><i class="fas fa-coins text-2xl mb-1"></i><span>è¨˜å¸³</span></button>
        <button class="nav-item flex flex-col items-center w-1/5" onclick="switchTab('guide', this)"><i class="fas fa-book-reader text-2xl mb-1"></i><span>å°è¦½</span></button>
        <button class="nav-item flex flex-col items-center w-1/5" onclick="switchTab('info', this)"><i class="fas fa-info-circle text-2xl mb-1"></i><span>è³‡è¨Š</span></button>
        <button class="nav-item flex flex-col items-center w-1/5" onclick="switchTab('check', this)"><i class="fas fa-archive text-2xl mb-1"></i><span>æ¸…å–®</span></button>
    </nav>

    <!-- Member Settings Modal -->
    <div id="member-modal" class="fixed inset-0 z-[70] hidden flex items-center justify-center bg-black/60 backdrop-blur-sm p-4">
        <div class="bg-white w-full max-w-sm rounded-lg shadow-xl p-6 modal-enter border border-earth-light">
            <h3 class="text-2xl font-bold text-earth-dark mb-4">è¨­å®šæ—…ä¼´æˆå“¡</h3>
            <p class="text-sm text-gray-500 mb-3">è¼¸å…¥åå­—ç”¨é€—è™Ÿéš”é–‹</p>
            <input type="text" id="member-input" class="w-full border p-3 rounded mb-5 focus:border-earth-primary outline-none text-lg">
            <div class="flex justify-end gap-3">
                <button onclick="document.getElementById('member-modal').classList.add('hidden')" class="px-5 py-2 text-gray-500 font-bold">å–æ¶ˆ</button>
                <button onclick="saveMembers()" class="px-5 py-2 bg-earth-primary text-white rounded font-bold">å„²å­˜</button>
            </div>
        </div>
    </div>

    <!-- Read Modal (Detailed Info) -->
    <div id="info-modal" class="fixed inset-0 z-[60] hidden flex items-center justify-center bg-black/70 backdrop-blur-sm p-4">
        <div class="bg-[#fffefb] w-full max-w-xl rounded-2xl shadow-2xl border border-earth-light relative modal-enter max-h-[85vh] overflow-y-auto">
            <div class="sticky top-0 bg-[#fffefb] p-6 border-b border-earth-light flex justify-between items-center z-10">
                <h3 id="modal-title" class="text-3xl font-bold text-earth-dark">æ™¯é»</h3>
                <button onclick="closeModal('info-modal')" class="text-gray-500 text-4xl"><i class="fas fa-times-circle"></i></button>
            </div>
            <div class="p-8">
                <div class="mb-5"><span id="modal-tag" class="inline-block bg-earth-accent text-white text-base px-4 py-1 rounded tracking-wider"></span></div>
                <div id="modal-content" class="prose prose-xl prose-stone font-sans leading-relaxed text-justify text-black font-medium"></div>
            </div>
        </div>
    </div>

    <!-- Edit Modal (Activity) -->
    <div id="edit-modal" class="fixed inset-0 z-[70] hidden flex items-center justify-center bg-black/70 backdrop-blur-sm p-4">
        <div class="bg-white w-full max-w-lg rounded-xl shadow-2xl p-6 modal-enter">
            <h3 class="text-2xl font-bold mb-5">ç·¨è¼¯æ´»å‹•</h3>
            <form id="edit-activity-form" class="space-y-5">
                <input type="hidden" id="edit-day-idx"><input type="hidden" id="edit-act-idx">
                <input type="text" id="edit-name" class="w-full border p-3 rounded text-lg" placeholder="åç¨±">
                <select id="edit-type" class="w-full border p-3 rounded text-lg"><option value="spot">æ™¯é»</option><option value="transport">äº¤é€š</option><option value="food">ç¾é£Ÿ</option><option value="hotel">ä½å®¿</option></select>
                <input type="text" id="edit-desc" class="w-full border p-3 rounded text-lg" placeholder="ç°¡è¿°">
                <textarea id="edit-detail" rows="5" class="w-full border p-3 rounded text-lg" placeholder="è©³ç´°"></textarea>
                <div class="flex justify-between pt-3">
                    <button type="button" onclick="deleteActivity()" class="text-red-500 font-bold text-lg">åˆªé™¤</button>
                    <div class="flex gap-4">
                        <button type="button" onclick="closeModal('edit-modal')" class="text-gray-500 text-lg font-bold">å–æ¶ˆ</button>
                        <button type="submit" class="bg-earth-primary text-white px-6 py-3 rounded font-bold text-lg">å„²å­˜</button>
                    </div>
                </div>
            </form>
        </div>
    </div>

    <!-- Edit Hotel Modal -->
    <div id="edit-hotel-modal" class="fixed inset-0 z-[70] hidden flex items-center justify-center bg-black/70 backdrop-blur-sm p-4">
        <div class="bg-white w-full max-w-sm rounded-xl shadow-2xl p-6 modal-enter">
            <h3 class="text-xl font-bold mb-4 text-earth-dark">ç·¨è¼¯ä½å®¿</h3>
            <input type="hidden" id="edit-hotel-day-idx">
            <label class="block text-sm font-bold text-gray-600 mb-2">é£¯åº—åç¨±</label>
            <input type="text" id="edit-hotel-name" class="w-full border p-3 rounded text-lg mb-5 focus:border-earth-primary outline-none">
            <div class="flex justify-end gap-3">
                <button onclick="closeModal('edit-hotel-modal')" class="px-4 py-2 text-gray-500 font-bold">å–æ¶ˆ</button>
                <button onclick="saveHotel()" class="px-4 py-2 bg-earth-primary text-white rounded font-bold">å„²å­˜</button>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script>
        const STORAGE_KEY = 'yunnan_trip_v16_final_fix';
        let currentRate = 4.5; 

        const cityCoords = { "æ˜†æ˜": { lat: 24.8801, long: 102.8329 }, "å¤§ç†": { lat: 25.6065, long: 100.2676 }, "æ²™æºª": { lat: 26.3167, long: 99.8500 }, "éº—æ±Ÿ": { lat: 26.8721, long: 100.2297 }, "ç€˜æ²½æ¹–": { lat: 27.6967, long: 100.7333 }, "é¦™æ ¼é‡Œæ‹‰": { lat: 27.8251, long: 99.7073 } };
        const defaultMembers = ["ç¾æƒ ", "å¿—ç¾©", "å¹´è±", "ç¾è‹±"];
        
        // Detailed Spot Info (Same as V15.1)
        const detailedSpots = {
            "æ˜†æ˜çŸ³æ—": "<h4>ğŸª¨ åœ°è³ªå¥‡è§€</h4><p>ä¸–ç•Œè‡ªç„¶éºç”¢ï¼Œå½¢æˆæ–¼2.7å„„å¹´å‰ã€‚é˜¿è©©ç‘ªå‚³èªªçš„ç™¼æºåœ°ã€‚</p>",
            "æ»‡æ± ": "<h4>ğŸŒŠ é«˜åŸæ˜ç </h4><p>é›²å—æœ€å¤§æ·¡æ°´æ¹–ï¼Œå†¬å­£å¯è§€è³ä¾†è‡ªè¥¿ä¼¯åˆ©äºçš„ç´…å˜´é·—ã€‚</p>",
            "å¤§ç†å¤åŸ": "<h4>ğŸ° å—è©”å¤éƒ½</h4><p>å§‹å»ºæ–¼æ˜æ´ªæ­¦åäº”å¹´ï¼ŒèƒŒé è’¼å±±é¢æœæ´±æµ·ã€‚å»ºç¯‰é¢¨æ ¼ç‚ºã€Œä¸‰åŠä¸€ç…§å£ã€ã€‚</p>",
            "äº”è¯æ¨“": "<h4>ğŸ“œ å¤©ä¸‹ç¬¬ä¸€æ¨“</h4><p>å—è©”åœ‹è³“é¤¨ï¼Œå¯ä¿¯ç°å¤åŸå…¨æ™¯ã€‚</p>",
            "æ´±æµ·ç’°æ¹–": "<h4>ğŸ’§ æ´±æµ·æœˆ</h4><p>ã€Œè’¼å±±ä¸å¢¨åƒç§‹ç•«ï¼Œæ´±æµ·ç„¡å¼¦è¬å¤ç´ã€ã€‚</p>",
            "é›™å»Šå¤é®": "<h4>âœ¨ è’¼æ´±é¢¨å…‰ç¬¬ä¸€é®</h4><p>ä½æ–¼æ´±æµ·æ±åŒ—å²¸ï¼Œæ˜¯æ¬£è³è½æ—¥çš„çµ•ä½³é»ã€‚</p>",
            "å–œåŸå¤é®": "<h4>ğŸ  ç™½æ—å»ºç¯‰åšç‰©é¤¨</h4><p>åš´å®¶å¤§é™¢æ˜¯å»ºç¯‰ç²¾é«“ã€‚å–œæ´²ç²‘ç²‘å¿…åƒã€‚</p>",
            "èŸ æºªSç£": "<h4>ğŸ›£ï¸ ç¶²ç´…æ‰“å¡</h4><p>ç”Ÿæ…‹å»Šé“ä¸Šæœ€ç¾çš„Så‹å½é“ã€‚</p>",
            "æ²™æºªå¤é®": "<h4>ğŸ´ èŒ¶é¦¬å¤é“</h4><p>å”¯ä¸€å€–å­˜çš„å¤é›†å¸‚ï¼Œå¯ºç™»è¡—å’Œå¤æˆ²å°æ˜¯æ ¸å¿ƒã€‚</p>",
            "ç‰æ´¥æ©‹": "<h4>ğŸŒ‰ æ­·å²å°è¨˜</h4><p>æ©«è·¨é»‘æƒ æ±Ÿçš„ç™¾å¹´çŸ³æ‹±æ©‹ã€‚</p>",
            "æ‹‰å¸‚æµ·": "<h4>ğŸŒ¿ èŒ¶é¦¬å¤é“</h4><p>é¨é¦¬èµ°å¤é“çš„ç†±é–€åœ°é»ã€‚</p>",
            "æŸæ²³å¤é®": "<h4>ğŸ  ç´è¥¿ä¹‹æº</h4><p>çš®åŒ ä¹‹é„‰ï¼Œæ¯”å¤§ç ”å¤é®æ›´å¯§éœã€‚</p>",
            "ç‰é¾é›ªå±±": "<h4>ğŸ”ï¸ ç´è¥¿ç¥å±±</h4><p>ä¸»å³°æ‰‡å­é™¡æµ·æ‹”5596ç±³ï¼Œè‡³ä»Šç„¡äººç™»é ‚ã€‚</p>",
            "è—æœˆè°·": "<h4>ğŸ’ è—è‰²çœ¼æ·š</h4><p>ç™½æ°´æ²³ï¼Œæ°´å‘ˆè’‚èŠ™å°¼è—ã€‚</p>",
            "å°è±¡éº—æ±Ÿ": "<h4>ğŸ­ éˆé­‚éœ‡æ’¼</h4><p>å¼µè—è¬€åŸ·å°ï¼Œæµ·æ‹”3100ç±³çš„å¯¦æ™¯æ¼”å‡ºã€‚</p>",
            "éº—æ±Ÿå¤åŸ": "<h4>ğŸ¯ ä¸–ç•Œéºç”¢</h4><p>æ²’æœ‰åŸç‰†çš„å¤åŸï¼Œå®¶å®¶æµæ°´ï¼Œæˆ¶æˆ¶å‚æ¥Šã€‚</p>",
            "ç€˜æ²½æ¹–": "<h4>ğŸ‘© æ±æ–¹å¥³å…’åœ‹</h4><p>æ‘©æ¢­äººèµ°å©šæ–‡åŒ–ï¼Œé«˜åŸæ˜ç ã€‚</p>",
            "èµ°å©šæ©‹": "<h4>â¤ï¸ å¤©ä¸‹ç¬¬ä¸€éµ²æ©‹</h4><p>è‰æµ·ä¸Šçš„é•·æ©‹ï¼Œæ‘©æ¢­ç”·å¥³ç´„æœƒåœ°ã€‚</p>",
            "è™è·³å³½": "<h4>ğŸŒŠ é©šæ¿¤é§­æµª</h4><p>ä¸–ç•Œä¸Šè½å·®æœ€å¤§çš„å³½è°·ä¹‹ä¸€ã€‚</p>",
            "ç¨å…‹å®—å¤åŸ": "<h4>ğŸŒ• æœˆå…‰ä¹‹åŸ</h4><p>æ“æœ‰ä¸–ç•Œæœ€å¤§çš„è½‰ç¶“ç­’ã€‚</p>",
            "æ¾è´Šæ—å¯º": "<h4>ğŸ™ å°å¸ƒé”æ‹‰å®®</h4><p>é›²å—æœ€å¤§çš„è—å‚³ä½›æ•™å¯ºé™¢ã€‚</p>",
            "ç´å¸•æµ·": "<h4>ğŸ é«˜åŸæ¿•åœ°</h4><p>ä¾æ‹‰è‰åŸï¼Œé»‘é ¸é¶´è¶Šå†¬åœ°ã€‚</p>",
            "å´‡è–å¯ºä¸‰å¡”": "<h4>ğŸ›• å¤§ç†åœ°æ¨™</h4><p>å¤§ç†åœ‹çš‡å®¶å¯ºé™¢ï¼Œä¸‰å¡”é¼ç«‹ã€‚</p>",
            "é¾é¾•ç¢¼é ­": "<h4>ğŸŒ… æ—¥å‡ºè–åœ°</h4><p>æ´±æµ·é‚Šçš„ç´…æ°´æ‰èˆ‡æ—¥å‡ºã€‚</p>"
        };

        const defaultItineraryData = [
            { 
                day: 1, date: "2/1 (æ—¥)", loc: "å°æ¸¯ âœˆï¸ æ˜†æ˜", hotel: "æ˜†æ˜ç«è»Šç«™åŒ—å»£å ´äºæœµé…’åº—", 
                activities: [ 
                    { name: "å‰å¾€å°æ¸¯æ©Ÿå ´", type: "transport", desc: "AM 8:00 é¹¿å¯®æ­7äººåº§å‰å¾€å°æ¸¯ã€‚", detailedInfo: null },
                    { 
                        name: "é£›å¾€æ˜†æ˜ (é»æ“Šçœ‹è©³æƒ…)", 
                        type: "transport", 
                        desc: "åœ‹æ³°CX431 (11:25) -> é¦™æ¸¯è½‰æ©Ÿ -> æ±èˆªMU734 (19:50æŠµé”)", 
                        detailedInfo: "<h4>ğŸ›« å»ç¨‹èˆªç­è©³æƒ… (2026/02/01)</h4><ul class='list-disc pl-5 mt-2 space-y-2'><li><strong>ç¬¬ä¸€æ®µ (åœ‹æ³°èˆªç©º CX431)</strong><br>é«˜é›„ (KHH) I èˆªå»ˆ 11:25 å‡ºç™¼<br>é¦™æ¸¯ (HKG) T1 èˆªå»ˆ 13:10 æŠµé”<br>é£›è¡Œæ™‚é–“: 01h 45m<br>è¡Œæ: 1ä»¶</li><li><strong>ğŸ”„ é¦™æ¸¯è½‰æ©Ÿ</strong><br>åœç•™æ™‚é–“: ç´„ 3å°æ™‚ 55åˆ†<br><span class='text-red-600 font-bold'>âš ï¸ éœ€åœ¨é«˜é›„ç¢ºèªè¡Œææ˜¯å¦ç›´æ›æ˜†æ˜ï¼Œè‹¥ç„¡å‰‡éœ€åœ¨é¦™æ¸¯å…¥å¢ƒé‡æ›ã€‚</span></li><li><strong>ç¬¬äºŒæ®µ (æ±æ–¹èˆªç©º MU734)</strong><br>é¦™æ¸¯ (HKG) 17:05 å‡ºç™¼<br>æ˜†æ˜ (KMG) 19:50 æŠµé”<br>è‰™ç­‰: ç¶“æ¿Ÿè‰™ S</li></ul>" 
                    }, 
                    { name: "å‰å¾€é£¯åº—", type: "transport", desc: "æ»´æ»´æ‰“è»Š (7äººåº§ä¸€è¼›æˆ–äº”äººåº§å…©è¼›)ã€‚", detailedInfo: null } 
                ], notes: "è«‹å†æ¬¡ç¢ºèªè¡Œæç›´æ›å•é¡Œã€‚" 
            },
            { 
                day: 2, date: "2/2 (ä¸€)", loc: "æ˜†æ˜", hotel: "æ˜†æ˜ç«è»Šç«™åŒ—å»£å ´äºæœµé…’åº—", 
                activities: [ 
                    { name: "çŸ³æ—+æ»‡æ± ä¸€æ—¥æ¸¸", type: "spot", desc: "æºç¨‹æ—…è¡Œè®¢å•åŒ…è»Š (äºŒç’°è»Šæ¥, 9é»å‡ºç™¼, 15äººå°åœ˜)ã€‚", detailedInfo: detailedSpots["æ˜†æ˜çŸ³æ—"] }, 
                    { name: "åˆé¤/æ™šé¤", type: "food", desc: "å«ä¸­é¤ï¼Œæ™šé¤è‡ªç† (éæ©‹ç±³ç·š/é…¸èœé­š/é‡ç”ŸèŒç«é‹)ã€‚", detailedInfo: null } 
                ], notes: "è¨‚å–®é€£çµ: https://t.ctrip.cn/?shE0F2n4E91E0 (è²»ç”¨Â¥810å·²ä»˜)" 
            },
            { 
                day: 3, date: "2/3 (äºŒ)", loc: "æ˜†æ˜ ğŸš— å¤§ç†", hotel: "å¤§ç† èµ°èµ°åœåœ", 
                activities: [ 
                    { name: "å‰å¾€å¤§ç†", type: "transport", desc: "ä¸Šåˆä½µè»Š (å› æœ‰å¤§ä»¶è¡Œæ)ã€‚", detailedInfo: null }, 
                    { name: "å¤§ç†å¤åŸ", type: "spot", desc: "åœ¨æœ‰é¢¨çš„åœ°æ–¹ç­‰ä½ ã€‚", detailedInfo: detailedSpots["å¤§ç†å¤åŸ"] }, 
                    { name: "é³³é™½é‚‘æ‘", type: "spot", desc: "æœ‰é¢¨çš„åœ°æ–¹æ‹æˆ²é»ã€‚", detailedInfo: null },
                    { name: "é¾é¾•ç¢¼é ­", type: "spot", desc: "æ´±æµ·é‚Šã€‚", detailedInfo: detailedSpots["é¾é¾•ç¢¼é ­"] },
                    { name: "å¤§ç†å¸‚å€", type: "spot", desc: "äº”è¯æ¨“ã€é›†è²¿å¸‚é›†ã€å´‡è–å¯ºä¸‰å¡”ã€‚", detailedInfo: detailedSpots["å´‡è–å¯ºä¸‰å¡”"] }
                ], notes: "äº¤é€š: ä½µè»Š/èŒƒå¸«å‚…ã€‚æ™šé¤: ç›¡å–„ç™¾å¹´å¤é™¢/æ®µå…¬å­ã€‚" 
            },
            { 
                day: 4, date: "2/4 (ä¸‰)", loc: "å¤§ç†", hotel: "å¤§ç† èµ°èµ°åœåœ", 
                activities: [ 
                    { name: "æ´±æµ·ç’°æ¹–", type: "spot", desc: "åŒ…è»Šç’°æ¹–ä¸€åœˆ (ç¾è‹±åˆ·å¡$1026)ã€‚", detailedInfo: detailedSpots["æ´±æµ·ç’°æ¹–"] }, 
                    { name: "é›™å»Šå¤é®", type: "spot", desc: "è¡Œç¨‹åƒè€ƒé»ã€‚", detailedInfo: detailedSpots["é›™å»Šå¤é®"] }, 
                    { name: "å–œåŸå¤é®", type: "spot", desc: "å–œæ´²å¤é®ã€‚", detailedInfo: detailedSpots["å–œåŸå¤é®"] },
                    { name: "èŸ æºªSç£", type: "spot", desc: "ç¶²ç´…æ‰“å¡é»ã€‚", detailedInfo: detailedSpots["èŸ æºªSç£"] },
                    { name: "é³³é™½å°æ‘", type: "spot", desc: "è¡Œç¨‹åƒè€ƒé»ã€‚", detailedInfo: null }
                ], notes: "äº¤é€š: åŒ…5äººåº§ã€‚ç”¨é¤: å°‹é‡é‡ç”ŸèŒ/æ‹¾å‘³åœ’ã€‚" 
            },
            { 
                day: 5, date: "2/5 (å››)", loc: "å¤§ç† ğŸš— æ²™æºª", hotel: "æ²™æºª æ¸…æ°´æ©‹é›…è‹‘é †è‹‘æ°‘å®¿", 
                activities: [ 
                    { name: "å‰å¾€æ²™æºª", type: "transport", desc: "8-10é» æ°‘å®¿æ‹¼è»Šåˆ°æ²™æºªã€‚", detailedInfo: null }, 
                    { name: "æ²™æºªå¤é®", type: "spot", desc: "å»æœ‰é¢¨çš„åœ°æ–¹æ‹æˆ²é»ã€‚", detailedInfo: detailedSpots["æ²™æºªå¤é®"] }, 
                    { name: "æœ‰é¢¨å°é®/å››æ–¹è¡—", type: "spot", desc: "å¤é®æ¼«éŠã€‚", detailedInfo: null },
                    { name: "ç‰æ´¥æ©‹", type: "spot", desc: "å¤æ©‹æµæ°´ã€‚", detailedInfo: detailedSpots["ç‰æ´¥æ©‹"] },
                    { name: "åŠå±±å’–å•¡", type: "spot", desc: "ç¶²ç´…æ™¯é»ã€‚", detailedInfo: null },
                    { name: "æ’®æ’®å°é¤¨", type: "food", desc: "ç”¨é¤é»ã€‚", detailedInfo: null }
                ], notes: "æ°‘å®¿ä½ç½®: ç‰æ´¥æ©‹æœ€å¾Œä¸€æ’é‚Šã€‚é¤é£²: é–¤ç›§å°è‹‘/åˆè¦‹æ²™æºªã€‚" 
            },
            { 
                day: 6, date: "2/6 (äº”)", loc: "æ²™æºª ğŸš— éº—æ±Ÿ", hotel: "éº—æ±Ÿ çŸ¥ä¸é›…èˆå®¢æ£§", 
                activities: [ 
                    { name: "å‰å¾€éº—æ±Ÿ", type: "transport", desc: "ä¸Šåˆæ‹¼è»Šå‰å¾€ã€‚", detailedInfo: null }, 
                    { name: "æ‹‰å¸‚æµ·", type: "spot", desc: "ä¸‹åˆè¡Œç¨‹ã€‚", detailedInfo: detailedSpots["æ‹‰å¸‚æµ·"] }, 
                    { name: "æŸæ²³å¤é®", type: "spot", desc: "æ™šä¸Šè¡Œç¨‹ã€‚", detailedInfo: detailedSpots["æŸæ²³å¤é®"] } 
                ], notes: "âš ï¸ ç¬¬ä¸€å¤©ä¸æ´—é ­ï¼Œé˜²é«˜å±±ç—‡ã€‚å…ˆè³¼æ°§æ°£ç“¶ã€‚äº¤é€š: ä½µè»Š/èŒƒã€‚æ™šé¤: ç‰æ³‰åœ°é“åœŸé›ã€‚" 
            },
            { 
                day: 7, date: "2/7 (å…­)", loc: "éº—æ±Ÿ", hotel: "éº—æ±Ÿ çŸ¥ä¸é›…èˆå®¢æ£§", 
                activities: [ 
                    { name: "ç‰é¾é›ªå±±", type: "spot", desc: "æ—¥ç…§é‡‘å±± (æµ·æ‹”3050)ã€‚", detailedInfo: detailedSpots["ç‰é¾é›ªå±±"] }, 
                    { name: "è—æœˆè°·", type: "spot", desc: "æ°´æœˆé–£ç«™ä¸‹è»Šã€‚", detailedInfo: detailedSpots["è—æœˆè°·"] }, 
                    { name: "é›²æ‰åª", type: "spot", desc: "éº—æ±Ÿå°ç‘å£« (æµ·æ‹”3250)ã€‚", detailedInfo: null }, 
                    { name: "å°è±¡éº—æ±Ÿç§€", type: "spot", desc: "å¯¦æ™¯æ¼”å‡ºã€‚", detailedInfo: detailedSpots["å°è±¡éº—æ±Ÿ"] },
                    { name: "éº—æ±Ÿå¤åŸ", type: "spot", desc: "æ™šä¸Š å¤§ç ”å¤é®ã€‚", detailedInfo: detailedSpots["éº—æ±Ÿå¤åŸ"] }
                ], notes: "è¼•è£æ—…è¡Œã€‚äº¤é€š: åŒ…5äººåº§ã€‚é¤é£²: èŒè‡ªç”±/é›²é›ªéº—/è€é´¨æ¹¯ (èŒƒæ¨è–¦)ã€‚" 
            },
            { 
                day: 8, date: "2/8 (æ—¥)", loc: "éº—æ±Ÿ ğŸš— ç€˜æ²½æ¹–", hotel: "ç€˜æ²½æ¹– æˆˆç“¦.èŠ±æ™‚é–“é…’åº—", 
                activities: [ 
                    { name: "å‰å¾€ç€˜æ²½æ¹–", type: "transport", desc: "åŒ…5äººåº§ (è¼•è£æ—…è¡Œ)ã€‚", detailedInfo: null }, 
                    { name: "ç€˜æ²½æ¹–ç’°æ¹–", type: "spot", desc: "é‡‘æ²™æ±Ÿè§€æ™¯å°ã€æƒ…äººç˜ã€é‡Œæ ¼åŠå³¶ã€‚", detailedInfo: detailedSpots["ç€˜æ²½æ¹–"] }, 
                    { name: "èµ°å©šæ©‹/è‰æµ·", type: "spot", desc: "æ‘©æ¢­æ–‡åŒ–ã€‚", detailedInfo: detailedSpots["èµ°å©šæ©‹"] } 
                ], notes: "é£¯åº—: èŒƒæ¨è–¦ã€‚ç”¨é¤: çŸ³é‹é­š/æ­¡æ¨‚äººå®¶æŸ´ç«é›/è€æ²„é…¸èœç‰›è‚‰ã€‚" 
            },
            { 
                day: 9, date: "2/9 (ä¸€)", loc: "ç€˜æ²½æ¹– ğŸš— é¦™æ ¼é‡Œæ‹‰", hotel: "é¦™æ ¼é‡Œæ‹‰ ä¸¹ç¸µ", 
                activities: [ 
                    { name: "å‰å¾€é¦™æ ¼é‡Œæ‹‰", type: "transport", desc: "5äººåº§ (è¼•è£æ—…è¡Œ)ã€‚", detailedInfo: null }, 
                    { name: "è™è·³å³½", type: "spot", desc: "é©šæ¿¤é§­æµªã€‚", detailedInfo: detailedSpots["è™è·³å³½"] }, 
                    { name: "ç¨å…‹å®—å¤åŸ", type: "spot", desc: "æœˆå…‰ä¹‹åŸã€‚", detailedInfo: detailedSpots["ç¨å…‹å®—å¤åŸ"] } 
                ], notes: "é£¯åº—: èŒƒæ¨è–¦ã€‚é¤é£²: çŠ›ç‰›è‚‰ã€‚" 
            },
            { 
                day: 10, date: "2/10 (äºŒ)", loc: "é¦™æ ¼é‡Œæ‹‰ ğŸš— éº—æ±Ÿ", hotel: "éº—æ±Ÿ çŸ¥ä¸é›…èˆ", 
                activities: [ 
                    { name: "æ¾è´Šæ—å¯º", type: "spot", desc: "å°å¸ƒé”æ‹‰å®®ã€‚", detailedInfo: detailedSpots["æ¾è´Šæ—å¯º"] }, 
                    { name: "ç´å¸•æµ·", type: "spot", desc: "ä¾æ‹‰è‰åŸã€‚", detailedInfo: detailedSpots["ç´å¸•æµ·"] },
                    { name: "è¿”å›éº—æ±Ÿ", type: "transport", desc: "åŒ…5äººåº§ã€‚", detailedInfo: null }
                ], notes: "è¼•è£æ—…è¡Œã€‚" 
            },
            { 
                day: 11, date: "2/11 (ä¸‰)", loc: "éº—æ±Ÿ ğŸš… æ˜†æ˜", hotel: "æ˜†æ˜ é›²ç«‹æ–¹äºæœµé…’åº—", 
                activities: [ 
                    { name: "éº—æ±Ÿå¤åŸ", type: "spot", desc: "ä¸Šåˆè‡ªç”±æ´»å‹•ã€‚", detailedInfo: detailedSpots["éº—æ±Ÿå¤åŸ"] }, 
                    { name: "å‰å¾€æ˜†æ˜", type: "transport", desc: "ä¸‹åˆ 1:05 é«˜éµåˆ°æ˜†æ˜ (å·²è¨‚, $6108)ã€‚", detailedInfo: null } 
                ], notes: "è·¯ç¨‹: é¦™æ ¼é‡Œæ‹‰-éº—æ±Ÿ130km, éº—æ±Ÿ-å¤§ç†150km, å¤§ç†-æ˜†æ˜230kmã€‚" 
            },
            { 
                day: 12, date: "2/12 (å››)", loc: "æ˜†æ˜ âœˆï¸ å°æ¸¯", hotel: "æº«æš–çš„å®¶", 
                activities: [ 
                    { name: "å‰å¾€æ©Ÿå ´", type: "transport", desc: "5:30 é£¯åº—é€æ©Ÿ (3å¤§+1ä¸­è¡Œæ)ã€‚", detailedInfo: null },
                    { 
                        name: "è¿”ç¨‹é£›æ©Ÿ (é»æ“Šçœ‹è©³æƒ…)", 
                        type: "transport", 
                        desc: "æ±èˆªMU9623 (08:45) -> é¦™æ¸¯è½‰æ©Ÿ -> åœ‹æ³°CX458 (18:15æŠµé”)", 
                        detailedInfo: "<h4>ğŸ›¬ å›ç¨‹èˆªç­è©³æƒ… (2026/02/12)</h4><ul class='list-disc pl-5 mt-2 space-y-2'><li><strong>ç¬¬ä¸€æ®µ (æ±æ–¹èˆªç©º MU9623)</strong><br>æ˜†æ˜ (KMG) 08:45 å‡ºç™¼<br>é¦™æ¸¯ (HKG) 11:05 æŠµé”<br>è‰™ç­‰: ç¶“æ¿Ÿè‰™ T</li><li><strong>ğŸ”„ é¦™æ¸¯è½‰æ©Ÿ</strong><br>åœç•™æ™‚é–“: ç´„ 5å°æ™‚ 40åˆ†<br><span class='text-green-600 font-bold'>æ™‚é–“å……è£•ï¼Œå¯å®‰æ’æ©Ÿå ´ä¼‘æ¯æˆ–ç”¨é¤ã€‚</span></li><li><strong>ç¬¬äºŒæ®µ (åœ‹æ³°èˆªç©º CX458)</strong><br>é¦™æ¸¯ (HKG) T1 èˆªå»ˆ 16:45 å‡ºç™¼<br>é«˜é›„ (KHH) I èˆªå»ˆ 18:15 æŠµé”<br>æ©Ÿå‹: Economy</li></ul>" 
                    } 
                ], notes: "è«‹èŒƒå°å§å¹«å¿™è·Ÿé£¯åº—è¨»æ˜é€æ©Ÿæ™‚é–“ã€‚" 
            }
        ];

        let itineraryData = []; let currentDayIndex = 0; let members = []; let checklistData = []; let memoData = [];

        function initData() {
            const storedItin = localStorage.getItem(STORAGE_KEY + '_itinerary');
            itineraryData = storedItin ? JSON.parse(storedItin) : JSON.parse(JSON.stringify(defaultItineraryData));
            if(!storedItin) saveItinerary();

            const storedMembers = localStorage.getItem(STORAGE_KEY + '_members');
            members = storedMembers ? JSON.parse(storedMembers) : defaultMembers;
            document.getElementById('member-input').value = members.join(', ');
            updateBudgetFormMembers();
            const storedCheck = localStorage.getItem(STORAGE_KEY + '_checklist_v2');
            checklistData = storedCheck ? JSON.parse(storedCheck) : ["è­·ç…§/å°èƒè­‰","æ©Ÿç¥¨","ç¾é‡‘","é«˜å±±ç—‡è—¥","ä¿æš–è¡£ç‰©","å……é›»å™¨"].map(t=>({text:t,checked:false}));
            const storedMemo = localStorage.getItem(STORAGE_KEY + '_memos');
            memoData = storedMemo ? JSON.parse(storedMemo) : ["è¨˜å¾—é—œç“¦æ–¯", "å¹«å§‘å§‘è²·æ™®æ´±èŒ¶"];
        }

        function saveItinerary() { localStorage.setItem(STORAGE_KEY + '_itinerary', JSON.stringify(itineraryData)); }
        function saveMembers() { const input=document.getElementById('member-input').value; members=input.split(/[,ï¼Œ]/).map(s=>s.trim()).filter(s=>s); localStorage.setItem(STORAGE_KEY+'_members',JSON.stringify(members)); document.getElementById('member-modal').classList.add('hidden'); updateBudgetFormMembers(); renderExpenses(); }
        function updateBudgetFormMembers() { document.getElementById('item-payer').innerHTML=members.map(m=>`<option value="${m}">${m}</option>`).join(''); document.getElementById('item-involved').innerHTML=members.map((m,i)=>`<label class="flex items-center text-sm font-bold bg-white px-2 py-1 rounded border border-earth-light"><input type="checkbox" value="${m}" checked class="mr-1 accent-earth-primary h-4 w-4">${m}</label>`).join(''); }
        
        async function fetchWeather(city, index) { const coords = cityCoords[city]; const widget = document.getElementById(`weather-widget-${index}`); if (!coords || !widget) return; try { const url = `https://api.open-meteo.com/v1/forecast?latitude=${coords.lat}&longitude=${coords.long}&current=temperature_2m,weather_code&timezone=Asia%2FShanghai`; const response = await fetch(url); const data = await response.json(); const code = data.current.weather_code; const temp = Math.round(data.current.temperature_2m); let icon = 'fa-sun'; let text = 'æ™´æœ—'; let color = 'text-orange-500'; if (code >= 1 && code <= 3) { icon = 'fa-cloud-sun'; text = 'å¤šé›²'; color = 'text-gray-500'; } else if (code >= 45 && code <= 48) { icon = 'fa-smog'; text = 'éœ§'; color = 'text-gray-400'; } else if (code >= 51 && code <= 67) { icon = 'fa-cloud-rain'; text = 'æœ‰é›¨'; color = 'text-blue-500'; } else if (code >= 71) { icon = 'fa-snowflake'; text = 'ä¸‹é›ª'; color = 'text-blue-300'; } widget.innerHTML = `<i class="fas ${icon} ${color} text-lg mr-1"></i> <span class="font-bold text-earth-dark">${city} ç›®å‰ ${temp}Â°C (${text})</span> <span class="text-xs text-gray-400 ml-2">(å¯¦æ™‚åƒè€ƒ)</span>`; } catch (error) { widget.innerHTML = `<span class="text-xs text-red-400">å¤©æ°£æ›´æ–°å¤±æ•—</span>`; } }

        function renderItinerary() { 
            const tabsContainer = document.getElementById('day-tabs-container'); const contentContainer = document.getElementById('day-content-container'); document.getElementById('total-days-display').innerText = itineraryData.length; 
            tabsContainer.innerHTML = itineraryData.map((item, index) => { const isActive = index === currentDayIndex; return `<button onclick="selectDay(${index})" class="day-tab inline-flex flex-col items-center justify-center min-w-[70px] h-[70px] px-2 mr-3 rounded-xl border border-earth-light bg-[#fffefb] text-earth-accent transition-all ${isActive ? 'active' : ''}"><span class="text-xs uppercase tracking-wider font-bold mb-1">Day</span><span class="text-2xl font-bold font-serif">${item.day}</span></button>`; }).join('') + `<div class="w-4 inline-block"></div>`; 
            const activeTab = tabsContainer.children[currentDayIndex]; if (activeTab) activeTab.scrollIntoView({ behavior: 'smooth', block: 'nearest', inline: 'center' }); 
            const item = itineraryData[currentDayIndex]; const city = item.loc.split(' ')[0].replace(/[\d\/\(\)æ—¥ä¸€äºŒä¸‰å››äº”å…­]/g, '').trim(); const locations = item.activities.map(a => a.name).filter(n => n.trim() !== ""); let mapCardHtml = ''; 
            
            if (locations.length > 0) { 
                const baseUrl = "http://api.map.baidu.com/direction";
                const origin = encodeURIComponent(locations[0]);
                const destination = encodeURIComponent(locations[locations.length - 1]);
                const fullMapUrl = `${baseUrl}?origin=${origin}&destination=${destination}&mode=driving&region=äº‘å—&output=html&src=webapp.yunnan_trip`;
                const pathString = locations.map(l => `<span class="whitespace-nowrap font-bold">${l}</span>`).join(' <i class="fas fa-angle-right text-xs mx-1 text-earth-primary"></i> '); 
                mapCardHtml = `<div class="card-earth p-4 mb-4 bg-earth-dark/5 border-dashed border border-earth-accent"><div class="flex justify-between items-center mb-2"><h4 class="font-bold text-earth-dark text-base"><i class="fas fa-map-marked-alt mr-2"></i>ä»Šæ—¥è·¯ç·š</h4></div><div class="text-sm mb-3 overflow-x-auto pb-1">${pathString}</div><a href="${fullMapUrl}" target="_blank" class="block w-full text-center bg-earth-primary text-white py-3 rounded-lg shadow font-bold text-sm">é–‹å•Ÿ ç™¾åº¦åœ°åœ– å°èˆª</a></div>`; 
            } 
            
            const activitiesHtml = item.activities.map((act, idx) => { 
                const mapUrl = `https://map.baidu.com/search/${encodeURIComponent(act.name)}`; 
                return `
                <div class="timeline-item group" data-idx="${idx}">
                    <div class="timeline-dot"></div>
                    <div class="card-earth py-4 pr-4 pl-12 relative bg-[#fffefb]">
                        <div class="absolute left-0 top-0 bottom-0 w-10 flex items-center justify-center handle bg-warm-bg rounded-l-lg border-r border-earth-light z-10"><i class="fas fa-grip-vertical text-earth-primary"></i></div>
                        <div class="flex justify-between items-start mb-2"><h4 class="font-bold text-earth-dark text-lg">${act.name}</h4><div class="flex gap-1 ml-2"><span class="text-xs px-2 py-1 rounded bg-warm-bg text-earth-primary border border-earth-light">${act.type === 'transport' ? 'äº¤é€š' : 'æ™¯é»'}</span><button onclick="openEditModal(${currentDayIndex}, ${idx})" class="text-gray-400 px-1"><i class="fas fa-pen"></i></button></div></div>
                        <p class="text-base text-gray-700 mb-3">${act.desc}</p>
                        <div class="flex gap-2 mt-auto pt-2 border-t border-dashed border-earth-light">
                            <a href="${mapUrl}" target="_blank" class="flex-1 text-center py-2 rounded border border-earth-accent text-earth-primary text-sm font-bold">åœ°åœ–</a>
                            ${act.detailedInfo ? `<button onclick="openReadModal(${currentDayIndex}, ${idx})" class="flex-1 text-center py-2 rounded bg-earth-primary text-white text-sm font-bold">å°è¦½</button>` : ''}
                        </div>
                    </div>
                </div>`; 
            }).join(''); 
            
            let hotelHtml = ''; 
            const hotelMapUrl = item.hotel ? `https://map.baidu.com/search/${encodeURIComponent(item.hotel)}` : '#';
            const displayHotel = item.hotel || '<span class="text-gray-400 italic">æœªè¨­å®šä½å®¿</span>';
            hotelHtml = `<div class="mt-6 p-4 bg-earth-light/20 border-2 border-earth-light rounded-xl flex justify-between items-center ml-6"><div class="flex-1"><h4 class="text-xs font-bold text-earth-accent uppercase tracking-wider mb-1">ğŸ›Œ ä»Šæ™šä½å®¿</h4><div class="text-lg font-black text-earth-dark font-serif">${displayHotel}</div></div><div class="flex gap-2"><button onclick="openEditHotelModal(${currentDayIndex})" class="w-10 h-10 flex items-center justify-center bg-white border border-earth-light rounded-lg shadow-sm text-earth-primary"><i class="fas fa-pen"></i></button>${item.hotel ? `<a href="${hotelMapUrl}" target="_blank" class="px-3 py-2 bg-earth-primary text-white rounded-lg font-bold shadow-sm text-sm flex items-center gap-1"><i class="fas fa-location-arrow"></i></a>` : ''}</div></div>`;
            const weatherHtml = `<div id="weather-widget-${currentDayIndex}" class="flex items-center justify-center gap-2 text-sm text-earth-primary bg-white p-3 rounded-lg mb-4 border border-earth-light shadow-sm weather-loading"><i class="fas fa-sync fa-spin"></i> æ­£åœ¨æ›´æ–° ${city} å¤©æ°£...</div>`; 
            contentContainer.innerHTML = `<div class="animate-fadeIn pb-8"><div class="flex items-center justify-between mb-4"><div class="inline-block bg-earth-primary text-white px-4 py-1 text-base font-bold rounded shadow">${item.date}</div><div class="text-earth-accent font-bold text-xl border-b-2 border-earth-accent pb-1">${city}</div></div>${weatherHtml}${mapCardHtml}<div class="timeline-container relative" id="day-activity-list">${activitiesHtml}</div><div class="mt-4 text-center ml-6"><button onclick="addNewActivity(${currentDayIndex})" class="w-full py-3 border-2 border-dashed border-earth-light text-earth-accent rounded-lg font-bold">ï¼‹ æ–°å¢è¡Œç¨‹</button></div>${hotelHtml}${item.notes ? `<div class="mt-6 border-t border-dashed border-earth-light pt-4 ml-6"><div class="flex items-start text-red-800 bg-red-50 p-3 rounded text-base border border-red-100 font-bold"><i class="fas fa-exclamation-triangle mr-2 mt-1"></i><span>${item.notes}</span></div></div>` : ''}</div>`; 
            
            const sortableEl = document.getElementById('day-activity-list');
            if (sortableEl && typeof Sortable !== 'undefined') {
                new Sortable(sortableEl, { handle: '.handle', animation: 150, onEnd: function (evt) { const act = itineraryData[currentDayIndex].activities; act.splice(evt.newIndex, 0, act.splice(evt.oldIndex, 1)[0]); saveItinerary(); renderItinerary(); } }); 
            }
            fetchWeather(city, currentDayIndex); 
        }

        function selectDay(index) { currentDayIndex = index; renderItinerary(); }
        function changeDay(delta) { const newIndex = currentDayIndex + delta; if (newIndex >= 0 && newIndex < itineraryData.length) selectDay(newIndex); }

        // --- Budget System ---
        function renderExpenses() {
            let expenses = JSON.parse(localStorage.getItem(STORAGE_KEY + '_expenses')) || [];
            let balances = {}; let totalCNY = 0; let totalTWD = 0;
            members.forEach(m => balances[m] = 0);
            
            expenses.forEach(ex => {
                let amount = parseFloat(ex.price);
                if (ex.currency === 'TWD') {
                    totalTWD += amount;
                    amount = amount / currentRate;
                } else {
                    totalCNY += amount;
                }

                if (balances[ex.payer] !== undefined) {
                    balances[ex.payer] += amount;
                }
                
                const involved = (ex.involved && ex.involved.length > 0) ? ex.involved : members; 
                const share = amount / involved.length;
                
                involved.forEach(person => { 
                    if (balances[person] !== undefined) {
                        balances[person] -= share; 
                    }
                });
            });

            document.getElementById('sum-cny').innerText = Math.round(totalCNY).toLocaleString();
            document.getElementById('sum-twd').innerText = Math.round(totalTWD).toLocaleString();
            
            const estTotal = Math.round(totalTWD + (totalCNY * currentRate));
            document.getElementById('total-est-twd').innerText = estTotal.toLocaleString();
            
            const boardHtml = Object.entries(balances).map(([name, amount]) => {
                const color = amount >= 0 ? "text-green-600" : "text-red-600";
                const action = amount >= 0 ? "æ‡‰æ”¶" : "æ‡‰ä»˜";
                return `<div class="flex justify-between border-b border-white/10 py-1 font-bold"><span>${name}</span><span class="${color}">${action} Â¥${Math.abs(Math.round(amount * 10) / 10)}</span></div>`;
            }).join('');
            document.getElementById('balance-board').innerHTML = boardHtml || '<p class="text-sm opacity-60">æš«ç„¡è³‡æ–™</p>';
            
            document.getElementById('expense-list').innerHTML = [...expenses].reverse().map(ex => {
                const currencyLabel = ex.currency === 'TWD' ? 'NT$' : 'Â¥';
                const payerInfo = `<span class="text-xs text-gray-500 block mt-1">${ex.payer} ä»˜æ¬¾ (${ex.involved ? ex.involved.length : members.length}äººåˆ†)</span>`;
                return `<div class="flex justify-between items-start bg-[#fffefb] p-4 border-b border-earth-light/50 rounded-lg shadow-sm mb-2"><div><span class="text-gray-900 font-bold text-lg">${ex.name}</span>${payerInfo}</div><div class="flex flex-col items-end"><span class="font-bold font-serif text-earth-dark text-xl">${currencyLabel} ${parseFloat(ex.price).toLocaleString()}</span><button onclick="deleteExpense(${ex.id})" class="text-gray-400 text-sm mt-1"><i class="fas fa-times"></i></button></div></div>`;
            }).join('');
        }

        // ç¶å®šäº‹ä»¶åˆ° window.onload ç¢ºä¿å…ƒç´ å­˜åœ¨
        window.onload = function() { 
            initData(); 
            renderItinerary(); 
            renderChecklist(); 
            renderMemos(); 
            renderGuide(); 
            renderFlights(); 
            renderExpenses(); 
            
            // Add Expense Button Listener
            const addBtn = document.getElementById('add-expense-btn');
            if(addBtn) {
                addBtn.addEventListener('click', function(e) {
                    e.preventDefault(); 
                    const name = document.getElementById('item-name').value;
                    const price = document.getElementById('item-price').value;
                    const currency = document.getElementById('item-currency').value;
                    const payer = document.getElementById('item-payer').value;
                    const involved = [];
                    document.querySelectorAll('#item-involved input:checked').forEach(cb => involved.push(cb.value));

                    if (!name || !price) { alert("è«‹è¼¸å…¥åç¨±èˆ‡é‡‘é¡"); return; }
                    if (involved.length === 0) { alert("è«‹è‡³å°‘é¸æ“‡ä¸€ä½åˆ†æ”¤äºº"); return; }

                    let expenses = JSON.parse(localStorage.getItem(STORAGE_KEY + '_expenses')) || [];
                    expenses.push({ id: Date.now(), name, price, currency, payer, involved });
                    localStorage.setItem(STORAGE_KEY + '_expenses', JSON.stringify(expenses));
                    
                    document.getElementById('item-name').value = '';
                    document.getElementById('item-price').value = '';
                    renderExpenses();
                });
            }
        }

        // ... Rest of utils ...
        function calculateRate(t) { const c=document.getElementById('calc-cny'), w=document.getElementById('calc-twd'); if(t==='cny'){let v=parseFloat(c.value);w.value=isNaN(v)?'':Math.round(v*currentRate);}else{let v=parseFloat(w.value);c.value=isNaN(v)?'':Math.round(v/currentRate);} }
        function updateRate() { currentRate = parseFloat(document.getElementById('current-rate').value) || 4.5; renderExpenses(); calculateRate('twd'); }
        function renderChecklist() { const con=document.getElementById('checklist-container'); con.innerHTML=checklistData.map((item,i)=>`<div class="flex items-center p-3 bg-[#fffefb] border-b border-earth-light hover:bg-warm-bg group"><input type="checkbox" class="h-6 w-6 text-earth-primary rounded" onchange="toggleCheckItem(${i})" ${item.checked?'checked':''}><span class="ml-4 flex-1 text-lg font-bold ${item.checked?'line-through text-gray-400':'text-gray-800'}">${item.text}</span><button onclick="deleteCheckItem(${i})" class="text-gray-300 hover:text-red-500 px-2"><i class="fas fa-trash"></i></button></div>`).join(''); document.getElementById('check-progress').innerText=checklistData.length?Math.round((checklistData.filter(i=>i.checked).length/checklistData.length)*100)+'%':'0%'; }
        document.getElementById('checklist-form').addEventListener('submit',e=>{e.preventDefault();const v=document.getElementById('new-check-item').value;if(!v)return;checklistData.push({text:v,checked:false});saveChecklist();renderChecklist();document.getElementById('new-check-item').value='';});
        function toggleCheckItem(i){checklistData[i].checked=!checklistData[i].checked;saveChecklist();renderChecklist();}
        function deleteCheckItem(i){if(confirm('åˆªé™¤?')){checklistData.splice(i,1);saveChecklist();renderChecklist();}}
        function saveChecklist(){localStorage.setItem(STORAGE_KEY+'_checklist_v2',JSON.stringify(checklistData));}
        function resetChecklist(){if(confirm('é‡ç½®?')){checklistData=["è­·ç…§/å°èƒè­‰","æ©Ÿç¥¨","ç¾é‡‘","é«˜å±±ç—‡è—¥"].map(t=>({text:t,checked:false}));saveChecklist();renderChecklist();}}
        function renderMemos(){const con=document.getElementById('memo-container');con.innerHTML=memoData.length?memoData.map((m,i)=>`<div class="flex justify-between items-center p-3 bg-yellow-50/50 border-b border-yellow-100 rounded"><span class="text-lg text-gray-800 font-medium">â— ${m}</span><button onclick="deleteMemo(${i})" class="text-gray-400 hover:text-red-500"><i class="fas fa-times"></i></button></div>`).join(''):'<div class="text-gray-400 text-sm italic text-center py-2">æš«ç„¡å‚™å¿˜</div>';}
        document.getElementById('memo-form').addEventListener('submit',e=>{e.preventDefault();const v=document.getElementById('new-memo-item').value;if(!v)return;memoData.push(v);saveMemos();renderMemos();document.getElementById('new-memo-item').value='';});
        function deleteMemo(i){if(confirm('åˆªé™¤?')){memoData.splice(i,1);saveMemos();renderMemos();}}
        function saveMemos(){localStorage.setItem(STORAGE_KEY+'_memos',JSON.stringify(memoData));}
        const guideData = { 
            foodByRegion: [ { region: "å¤§ç†", restaurants: [ {name:"ç›¡å–„ç™¾å¹´å¤é™¢é¤å»³", loc:"åšæ„›è·¯", hours:"10:30-22:30", specialty:"åœŸé›é‡ç”ŸèŒ", desc:"ç’°å¢ƒå¤è‰²å¤é¦™ã€‚"}, {name:"æ®µå…¬å­Â·ç¥éµ°ä¿ ä¾¶åº—", loc:"äººæ°‘è·¯", hours:"11:00-22:30", specialty:"èŠ±é†‰é­š", desc:"æ­¦ä¿ ä¸»é¡Œã€‚"}, {name:"å°‹é‡é‡ç”ŸèŒç«é‹", loc:"äººæ°‘è·¯", hours:"10:00-24:00", specialty:"é‡ç”ŸèŒ", desc:"æ¹¯é ­é®®ç¾ã€‚"} ] }, { region: "æ²™æºª", restaurants: [ {name:"åˆè¦‹æ²™æºªç§æˆ¿èœ", loc:"å¤é®å…§", hours:"11:30-20:30", specialty:"é…¸æ¹¯é­š", desc:"å®‰éœåœ°é“ã€‚"} ] }, { region: "éº—æ±Ÿ", restaurants: [ {name:"ç‰æ³‰åœ°é“åœŸé›", loc:"èŠ±é¦¬è¡—", hours:"09:30-22:00", specialty:"ç´è¥¿åœŸé›", desc:"è€å­—è™Ÿã€‚"} ] } ],
            spotCategories: [ {title:"éº—æ±Ÿ", items: Object.keys(detailedSpots).filter(k=>["ç™½æ²™å¤é®","å°è±¡éº—æ±Ÿ","èŒ¶é¦¬å¤é“","ç‰æ¹–æ‘"].includes(k))}, {title:"å¤§ç†", items: Object.keys(detailedSpots).filter(k=>["è’¼å±±","é¾é¾•ç¢¼é ­","å–œæ´²å¤é®","å·å±±å¤åŸ","èˆˆç››å¤§æ©‹"].includes(k))}, {title:"é¦™æ ¼é‡Œæ‹‰", items: Object.keys(detailedSpots).filter(k=>["è™è·³å³½","ç¨å…‹å®—å¤åŸ","æ¾è´Šæ—å¯º","ç€˜æ²½æ¹–"].includes(k))} ],
            souvenirs: [ {name:"é®®èŠ±é¤…", desc:"ç«ç‘°é¤¡ã€‚", shops:"å˜‰è¯", addr:"å¸‚å€"}, {name:"æ™®æ´±èŒ¶", desc:"è¶Šé™³è¶Šé¦™ã€‚", shops:"å¤§ç›Š", addr:"èŒ¶åŸ"}, {name:"èŒè‡ä¹¾è²¨", desc:"ç‡‰æ¹¯æ¥µå“ã€‚", shops:"è¾²è²¿å¸‚å ´", addr:"ç¯†æ–°"}, {name:"éŠ€é£¾", desc:"ç´”åº¦é«˜ã€‚", shops:"ç™¾æ­²åŠ", addr:"å¤åŸ"}, {name:"æ‰æŸ“", desc:"è—ç™½å¸ƒè—ã€‚", shops:"å‘¨åŸ", addr:"å–œæ´²"} ]
        };
        function renderGuide() {
            document.getElementById('food-guide-list').innerHTML = guideData.foodByRegion.map(g => `<div class="mb-6"><h4 class="font-bold text-xl mb-4 text-earth-primary border-l-[6px] border-earth-primary pl-3">${g.region}</h4><ul class="space-y-4">${g.restaurants.map(i => { const mapUrl=`https://map.baidu.com/search/${encodeURIComponent(i.name+" "+i.loc)}`; return `<li class="p-4 border border-earth-light bg-[#fffefb] rounded-xl shadow-sm"><div class="flex justify-between items-start mb-2"><div class="flex-1"><div class="font-bold text-earth-dark text-xl">${i.name}</div><div class="text-sm text-earth-primary font-bold mt-1"><i class="fas fa-map-marker-alt mr-1"></i>${i.loc}</div></div><a href="${mapUrl}" target="_blank" class="bg-earth-accent text-white px-3 py-1 rounded text-sm font-bold shadow">å°èˆª</a></div><div class="text-base text-gray-800 space-y-1 mt-3 border-t border-dashed border-earth-light pt-2"><div><span class="font-bold">ç‡Ÿæ¥­ï¼š</span>${i.hours}</div><div><span class="font-bold">æ‹›ç‰Œï¼š</span>${i.specialty}</div><div class="text-gray-600 italic text-sm">"${i.desc}"</div></div></li>`; }).join('')}</ul></div>`).join('');
            document.getElementById('souvenir-guide-list').innerHTML = guideData.souvenirs.map(s => `<div class="border border-earth-light bg-[#fffefb] p-4 rounded-xl shadow-sm"><h4 class="font-bold text-earth-dark text-xl mb-2">${s.name}</h4><p class="text-base text-gray-700 mb-2">${s.desc}</p><div class="text-sm bg-warm-bg p-2 rounded border border-earth-light/30"><div class="mb-1"><span class="font-bold text-earth-primary">æ¨è–¦ï¼š</span>${s.shops}</div><div><span class="font-bold text-earth-primary">åœ°å€ï¼š</span>${s.addr}</div></div></div>`).join('');
            document.getElementById('spot-guide-list').innerHTML = guideData.spotCategories.map(c=>`<div class="mb-6"><h4 class="font-bold text-earth-primary text-xl mb-3 border-l-[6px] border-earth-primary pl-3">${c.title}</h4><div class="flex flex-wrap gap-3">${c.items.map(i => `<button onclick="openDeepDive('${i}')" class="bg-[#fffefb] border-2 border-earth-light p-4 rounded-xl shadow-sm hover:bg-warm-bg hover:border-earth-accent transition-all text-left group"><div class="font-bold text-lg text-earth-dark group-hover:text-earth-primary">${i}</div><div class="text-xs text-gray-500 mt-2 font-bold flex items-center group-hover:text-earth-accent"><i class="fas fa-book-open mr-1"></i> é»æ“Šè©³é–±</div></button>`).join('')}</div></div>`).join('');
        }
        function openDeepDive(spotName) { const content = detailedSpots[spotName] || "<p>æš«ç„¡è©³ç´°è³‡æ–™</p>"; document.getElementById('modal-title').innerText = spotName; document.getElementById('modal-tag').innerText = "æ·±åº¦å°è¦½"; document.getElementById('modal-content').innerHTML = content; document.getElementById('info-modal').classList.remove('hidden'); }
        function switchTab(id, btn) { document.querySelectorAll('.tab-content').forEach(e=>e.classList.remove('active')); document.getElementById('tab-'+id).classList.add('active'); document.querySelectorAll('.nav-item').forEach(e=>e.classList.remove('active')); btn.classList.add('active'); window.scrollTo(0,0); }
        function scrollToId(id) { document.getElementById(id).scrollIntoView({behavior:'smooth'}); }
        function openReadModal(d, a) { const act=itineraryData[d].activities[a]; document.getElementById('modal-title').innerText=act.name; document.getElementById('modal-tag').innerText=act.type==='spot'?'æ·±åº¦å°è¦½':'è³‡è¨Š'; document.getElementById('modal-content').innerHTML=act.detailedInfo; document.getElementById('info-modal').classList.remove('hidden'); }
        function closeModal(id) { document.getElementById(id).classList.add('hidden'); }
        function deleteExpense(id) { if(confirm('åˆªé™¤?')) { let es=JSON.parse(localStorage.getItem(STORAGE_KEY+'_expenses'))||[]; localStorage.setItem(STORAGE_KEY+'_expenses',JSON.stringify(es.filter(e=>e.id!==id))); renderExpenses(); } }
        function clearAllData(t) { if(confirm('ç¢ºå®šæ¸…é™¤?')) { localStorage.removeItem(STORAGE_KEY+'_'+t); location.reload(); } }
        function renderFlights(){ let fs=JSON.parse(localStorage.getItem(STORAGE_KEY+'_flights'))||[]; document.getElementById('flight-list').innerHTML=fs.map(f=>`<div class="flex justify-between p-2 bg-white border rounded shadow-sm"><span>${f.str}</span><button onclick="if(confirm('åˆªé™¤?')){let fs=JSON.parse(localStorage.getItem('${STORAGE_KEY}_flights'))||[];localStorage.setItem('${STORAGE_KEY}_flights',JSON.stringify(fs.filter(x=>x.id!=${f.id})));renderFlights()}" class="text-red-500">x</button></div>`).join(''); }
        document.getElementById('flight-form').addEventListener('submit',e=>{e.preventDefault();let v=document.getElementById('flight-info-str').value;if(!v)return;let fs=JSON.parse(localStorage.getItem(STORAGE_KEY+'_flights'))||[];fs.push({id:Date.now(),str:v});localStorage.setItem(STORAGE_KEY+'_flights',JSON.stringify(fs));document.getElementById('flight-info-str').value='';renderFlights();});
        function exportData(){const d={itinerary:JSON.parse(localStorage.getItem(STORAGE_KEY+'_itinerary')),expenses:JSON.parse(localStorage.getItem(STORAGE_KEY+'_expenses')),flights:JSON.parse(localStorage.getItem(STORAGE_KEY+'_flights')),checklist:checklistData,memos:memoData,members:members};const a=document.createElement('a');a.href="data:text/json;charset=utf-8,"+encodeURIComponent(JSON.stringify(d));a.download="Yunnan_Trip_2026.json";document.body.appendChild(a);a.click();a.remove();}
        function importData(el){const f=el.files[0];if(!f)return;const r=new FileReader();r.onload=e=>{try{const d=JSON.parse(e.target.result);if(d.itinerary)localStorage.setItem(STORAGE_KEY+'_itinerary',JSON.stringify(d.itinerary));if(d.expenses)localStorage.setItem(STORAGE_KEY+'_expenses',JSON.stringify(d.expenses));if(d.flights)localStorage.setItem(STORAGE_KEY+'_flights',JSON.stringify(d.flights));if(d.checklist)localStorage.setItem(STORAGE_KEY+'_checklist_v2',JSON.stringify(d.checklist));if(d.memos)localStorage.setItem(STORAGE_KEY+'_memos',JSON.stringify(d.memos));if(d.members)localStorage.setItem(STORAGE_KEY+'_members',JSON.stringify(d.members));alert('åŒ¯å…¥æˆåŠŸ');location.reload();}catch(e){alert('éŒ¯èª¤');}};r.readAsText(f);}
        function openEditModal(d,a){const act=itineraryData[d].activities[a];document.getElementById('edit-day-idx').value=d;document.getElementById('edit-act-idx').value=a;document.getElementById('edit-name').value=act.name;document.getElementById('edit-type').value=act.type;document.getElementById('edit-desc').value=act.desc;document.getElementById('edit-detail').value=act.detailedInfo||'';document.getElementById('edit-modal').classList.remove('hidden');}
        function addNewActivity(d){itineraryData[d].activities.push({name:"æ–°è¡Œç¨‹",type:"spot",desc:"ç·¨è¼¯æè¿°",detailedInfo:""});saveItinerary();renderItinerary();openEditModal(d,itineraryData[d].activities.length-1);}
        function deleteActivity(){if(!confirm('åˆªé™¤?'))return;const d=document.getElementById('edit-day-idx').value;const a=document.getElementById('edit-act-idx').value;itineraryData[d].activities.splice(a,1);saveItinerary();closeModal('edit-modal');renderItinerary();}
        document.getElementById('edit-activity-form').addEventListener('submit',e=>{e.preventDefault();const d=document.getElementById('edit-day-idx').value;const a=document.getElementById('edit-act-idx').value;itineraryData[d].activities[a]={name:document.getElementById('edit-name').value,type:document.getElementById('edit-type').value,desc:document.getElementById('edit-desc').value,detailedInfo:document.getElementById('edit-detail').value};saveItinerary();closeModal('edit-modal');renderItinerary();});
        function openEditHotelModal(d){const h=itineraryData[d].hotel||"";document.getElementById('edit-hotel-day-idx').value=d;document.getElementById('edit-hotel-name').value=h;document.getElementById('edit-hotel-modal').classList.remove('hidden');}
        function saveHotel(){const d=document.getElementById('edit-hotel-day-idx').value;itineraryData[d].hotel=document.getElementById('edit-hotel-name').value;saveItinerary();renderItinerary();closeModal('edit-hotel-modal');}
        function closeModal(id){document.getElementById(id).classList.add('hidden');}
        window.onclick=function(e){if(e.target.id.includes('modal'))closeModal(e.target.id);}
    </script>
</body>
</html>